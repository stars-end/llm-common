name: DX PR Metadata

on:
  pull_request:

jobs:
  enforce:
    name: Enforce Feature-Key + Agent
    runs-on: ubuntu-latest
    steps:
      - name: Enforce PR metadata
        run: |
          python3 - <<'PY'
          import json, os, re, sys
          event_path = os.environ.get("GITHUB_EVENT_PATH")
          if not event_path:
            print("ERROR: GITHUB_EVENT_PATH not set")
            sys.exit(1)

          with open(event_path, "r", encoding="utf-8") as f:
            event = json.load(f)

          pr = event.get("pull_request") or {}
          title = pr.get("title") or ""
          body = pr.get("body") or ""
          author = (pr.get("user") or {}).get("login") or ""

          # NOTE: Use a real word-boundary pattern. Do NOT double-escape \b in a raw string.
          if not re.search(r"\bbd-[a-z0-9]+\b", title):
            print("ERROR: PR title missing Feature-Key (bd-XXXX)")
            print("Include the Beads id in the PR title, e.g.:")
            print("  bd-abcd: Short summary")
            sys.exit(1)

          if author in {"dependabot[bot]", "renovate[bot]", "github-actions[bot]"}:
            print(f"INFO: Bot PR ({author}): skipping Agent: enforcement")
            sys.exit(0)

          if "Agent:" not in body:
            print("ERROR: PR body missing 'Agent:'")
            print("Add to PR body, e.g.:")
            print("  Agent: codex")
            sys.exit(1)

          print("OK: PR metadata enforcement passed")
          PY
